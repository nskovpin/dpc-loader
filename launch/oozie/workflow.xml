<workflow-app name="${PROJECT_NAME}" 
	xmlns="uri:oozie:workflow:0.4">
	<global>
        <job-tracker>${JOB_TRACKER}</job-tracker>
        <name-node>${NAME_NODE}</name-node>
        <job-xml>${WF_APPLICATION_PATH}/hive-site.xml</job-xml>
        <configuration>
            <property>
                <name>mapreduce.job.queuename</name>
                <value>${QUEUE_NAME}</value>
            </property>
            <property>
                <name>oozie.hive.defaults</name>
                <value>${WF_APPLICATION_PATH}/hive-site.xml</value>
            </property>
			<property>
                <name>oozie.launcher.mapreduce.map.memory.mb</name>
                <value>1536</value>
            </property>
            <property>
                <name>oozie.launcher.mapreduce.job.ubertask.enable</name>
                <value>true</value>
            </property>
            <property>
                <name>oozie.launcher.yarn.app.mapreduce.am.resource.mb</name>
                <value>6144</value>
            </property>
        </configuration>
    </global>
	
	<credentials>
        <credential name="hive_cred" type="hcat">
            <property>
                <name>hcat.metastore.uri</name>
                <value>${HCAT_URI}</value>
            </property>
            <property>
                <name>hcat.metastore.principal</name>
                <value>${KRB_PRINCIPAL}</value>
            </property>
        </credential>
    </credentials>
	
	<start to="agg_taxi_service"/>
	
	<action name="agg_taxi_service" cred="hive_cred">
	<spark xmlns="uri:oozie:spark-action:0.1">
		<job-tracker>${JOB_TRACKER}</job-tracker>
		<name-node>${NAME_NODE}</name-node>
		<master>yarn</master>
		<mode>cluster</mode>
		<name>AGG_TAXI_SERVICE</name>
		<class>${MAIN_CLASS}</class>
		<jar>${JAR_PATH}</jar>
		<spark-opts>${SPARK_OPTS} --queue ${QUEUE_NAME}</spark-opts>
		<arg>TEST=false</arg>
		<arg>DATE_1W=${DATE_3D}</arg>
		<arg>PATH_CDR=${PATH_CDR}</arg>
		<arg>PATH_JARUS_HTTP=${PATH_JARUS_HTTP}</arg>
		<arg>PATH_JARUS_SSL=${PATH_JARUS_SSL}</arg>
		<arg>PATH_DIM_BS_REGIONS=${PATH_BS_POSITIONS}</arg>
		<arg>PATH_DIM_SERV_ONLINE_HOST=${PATH_DIM_SERV_ONLINE_HOST}</arg>
		<arg>PATH_DIM_SERV_ONLINE_SSL=${PATH_DIM_SERV_ONLINE_SSL}</arg>
		<arg>PATH_DIM_SERV_OFFLINE=${PATH_DIM_SERV_OFFLINE}</arg>
		<arg>OUTPUT_DIR=${OUTPUT_DIR}</arg>
	</spark>
	<ok to="alter_tables"/>
	<error to="kill"/>
	</action>

	<action name="alter_tables" cred="hive_cred">
	<shell xmlns="uri:oozie:shell-action:0.1">
		<job-tracker>${JOB_TRACKER}</job-tracker>
		<name-node>${NAME_NODE}</name-node>
		<exec>${WORK_DIR}/shell/${ALTER_TABLE_SCRIPT}</exec>
		<argument>${DATE_3D}</argument>
		<argument>${OUTPUT_DIR}</argument>
		<argument>${SPP}</argument>
		<argument>${QUEUE_NAME}</argument>
		<env-var>USER=$USER</env-var>
		<file>${WORK_DIR}/shell/${ALTER_TABLE_SCRIPT}#${ALTER_TABLE_SCRIPT}</file>
		<file>${WORK_DIR}/hive/alter_create_agg_taxi_service.hql#alter_create_agg_taxi_service.hql</file>
		<file>${WORK_DIR}/hive/alter_create_stg_taxi_user_activity.hql#alter_create_stg_taxi_user_activity.hql</file>
	</shell>
	<ok to="end"/>
	<error to="kill"/>
	</action>

    <kill name="kill">
        <message>Action failed, error message[${wf:errorMessage(wf:lastErrorNode())}]</message>
    </kill>

    <end name="end"/>

</workflow-app>